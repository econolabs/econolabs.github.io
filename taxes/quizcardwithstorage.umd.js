(function(e){typeof define=="function"&&define.amd?define(e):e()})((function(){"use strict";const e=document.querySelector.bind(document),P=document.querySelectorAll.bind(document);let k,f,z,{createRtkFirebaseStore:me,api:w,getUser:U,identifyQuiz:L,foundQuiz:R,getFirebaseNodeKey:N,formulaParser:V,shuffle:A,debounce:fe,debounceCallRangeValueСalculation:x,processquizwithrandomnumber:M,debounceCallCellValueСalculation:G,saveState:_}=basicfirebasecrudservices,{EconolabsCheckQuiz:K,EconolabsChoiceQuiz:Z,markupForDataArray:Q}=vanillajsdommanagement;const n=basicfirebasecrudservices.createRtkFirebaseStore();let{setUser:J,setSelectedOption:W,setInitialQuizOptions:X,setActivePage:B,setSelectedOptions:E,addCorrectQuiz:Y,loadCorrectquizes:ee}=basicfirebasecrudservices.applicationActions,S=new V;function te(a,t,i,s){let{userEmail:l,user:g,avatarUrl:u,email:v,activePage:y}=n.getState().application,{title:c,theme:d,text:b,hint:m="",dataArray:h=[]}=f.data[y],p=N("usersCraft/"+l+"/posts"),H=new Intl.DateTimeFormat("en",{weekday:"short",year:"numeric",month:"short",day:"numeric"}).format(new Date).replace(/[^a-zA-Z0-9]/g,"_"),q={id:p,title:c,theme:d,comment:c+" ("+d+")",type:t,answer:a,content:i,quizString:s,deleted:!1,email:v,user:g,avatarUrl:u,date:new Intl.DateTimeFormat("ru",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}).format(new Date)},r={id:p,title:c,theme:d,email:v,user:g,avatarUrl:u,timestamp:+Date.now()},o={};o["usersCraft/"+l+"/posts/"+p]=q,o["currentDay/"+H+"/posts/"+p]=r,n.dispatch(w.endpoints.updatesForOpenQuizes.initiate({base:"",updates:o})).then(()=>{n.dispatch(Y(L(c,b))),e("#answerButton").classList.toggle("btn-outline-primary"),e("#answerButton").classList.toggle("btn-success"),e("#quizHint").innerHTML=m,e("#answerButton").disabled=!0})}function ae(a){a.preventDefault();let{selectedoption:t,selectedoptions:i,activePage:s}=n.getState().application,{text:l,answer:g,hint:u="",dataArray:v=[],type:y,answers:c=[]}=f.data[s],d=!1,b="",m,h,p;e("#userComment").style.display="none";try{let r=e("#userComment").value;b=r!=="Мой комментарий"?r:""}catch{b=""}const H=new FormData(e("#quizform"));let q={};for(const[r,o]of H)q[r]=o;if(y==="accounting"&&e("#debet").value+e("#credit").value===c[0]&&(d=!0,m="Дт "+e("#debet").value+" Кт "+e("#credit").value,h=l+"<br>"+u+"<br>"+b,p="multiplechoices"),y==="multiplechoices"&&c.length===1&&t===c[0]&&(d=!0,m=t,h=l+"<br>"+u+"<br>"+b,p="multiplechoices"),y==="multiplechoices"&&c.length>1&&(i.length===c.length&&(d=!0,i.map(r=>{c.includes(r)||(d=!1)})),m=i.map(r=>r).join("   "),h=l+"<br>"+u+"<br>"+b,p="multiplechoices"),y==="quizwithrandomnumber"){let r=M({quizString:l,answer:g,randomNumber:n.getState().application.selectedoption});m=r.answer,h=r.quizString+"<br>"+u+"<br>"+b,p="multiplechoices";let o=e("#feedback").value;parseFloat(o)/parseFloat(m)<1.02&&parseFloat(o)/parseFloat(m)>.98&&(d=!0,e("#inputFormula").value.length>2&&(u=u+"<br>"+e("#inputFormula").value))}if(y==="casewithrandomnumber"){S.on("callRangeValue",function($,O,de){for(var T=[],C=$.row.index;C<=O.row.index;C++){for(var pe=v[C],j=[],F=$.column.index;F<=O.column.index;F++)j.push(pe[F]);T.push(j)}T&&de(T)});let r=S.parse(q[Object.keys(q)[0]].slice(1)),o=S.parse(g);!r?.error&&!o?.error&&parseFloat(o.result)/parseFloat(r.result)<1.02&&parseFloat(o.result)/parseFloat(r.result)>.98&&(d=!0,e("#formularesult").innerHTML=r.result,m="="+g,h=l+"<br>"+Q(v)+"<br>"+u+"<br>"+b,p="multiplechoices")}d?te(m,p,h,h):(e("#answerButton").classList.toggle("btn-danger"),e("#answerButton").classList.toggle("btn-outline-primary"),e("#quizHint").innerHTML=u,e("#answerButton").disabled=!0)}function ie(a){n.dispatch(W(a))}function ne(a){let t=n.getState().application.selectedoptions.map(s=>s);const i=t.indexOf(a);i>-1?(t.splice(i,1),n.dispatch(E(t))):n.dispatch(E([...t,a]))}async function se(a){let t=f.data[a];z=await n.dispatch(w.endpoints.fetchOpenQuizCaseById.initiate(t.quizesCasesId));let i=t?.hint?t.hint:"";z.data?.hint&&(i=z.data.hint+"<br>"+i),z.data?.exampleSpreadsheet&&(i=z.data.exampleSpreadsheet+"<br>"+i),e("#quizHint").innerHTML=i,D(a)}function D(a){let t=f.data[a];if(e("#quizformdataarray").style.display="none",e("#usercalculations").style.display="none",e("#inputFormula").value="",e("#resformula").innerHTML="<small class='text-muted'>Песочница, попробуйте =2+2 или =AVERAGE(B2:B13)</small>",e("#answerButton").disabled=!1,e("#quizTitle").innerHTML=t.title,e("#quizHeader").innerText=t.header+" "+(a+1),e("#userComment").style.display="block",e("#answerButton").className="btn btn-outline-primary m-3",e("#answerButton").style.display="block",t?.type==="casewithrandomnumber"&&Array.isArray(t?.dataArray)&&(e("#usercalculations").style.display="block",e("#quizformdataarray").innerHTML=Q(t?.dataArray)+"<br>"+t?.text+"<hr>",e("#quizformdataarray").style.display="block",e("#quizHint").innerHTML=t?.hint),t.type==="multiplechoices"&&(e("#quizString").innerHTML=t.text,t.answers.length>1?ue.addEvents(A([...t.choices])):oe.addEvents(A([...t.choices]))),t.type==="accounting"){e("#quizString").innerHTML=t.text;let i=`
           <div class="row m-1 g-1">
                <div class="col-12 col-md-6">
                    <select class="form-select form-select-sm" aria-label="debet" id="debet" name="debet"">
                    ${'<option value="...">Дебет</option>'+t.choices.map(s=>`<option value="${s}">${s}</option>`).join("")}                       
                    </select>
                </div>
                <div class="col-12 col-md-6">
                    <select class="form-select form-select-sm" aria-label="credit" id="credit" name="credit">
                       ${'<option value="...">Кредит</option>'+t.choices.map(s=>`<option value="${s}">${s}</option>`).join("")}
                    </select>
                </div>
           </div>
           `;e("#accountingblock").innerHTML=i,e("#accountingblock").style.display="block"}if(t.type==="quizwithrandomnumber"){e("#usercalculations").style.display="block";let i=M({quizString:t.text,answer:t.answer,randomNumber:n.getState().application.selectedoption});e("#quizString").innerHTML=i.quizString,e("#quizChecks").innerHTML=`
            <div class="input-group input-group-sm mb-3">
                <span class="input-group-text" id="inputGroup-sizing-sm">Число</span>
                <input type="text" class="form-control" aria-label="quizinput" aria-describedby="quiz-input-sm" id="feedback">
            </div>`}I()}function I(){if(Array.isArray(f?.data)){let a=n.getState().application.correctquizes;e("#quizbuttonslist").innerHTML=f.data.map((i,s)=>`<button
        class='${R(L(i.title,i.text),a)?"btn btn-sm btn-success page m-1":"btn btn-sm btn-outline-secondary page m-1"}'
        page=${s}
       >
        ${s+1}
        </button>`).join("")+'<a href="/myworkbook" title="Рабочая тетрадь" class="btn btn-sm btn btn-outline-primary m-1" target="_blank">РТ</a>',[...P(".page")].forEach(function(i){i.addEventListener("click",function(s){const l=parseInt(s.target.getAttribute("page"));n.dispatch(X()),n.dispatch(B(l)),e("#userComment").value="Мой комментарий",e("#quizChecks").innerHTML="",e("#accountingblock").style.display="none",e("#quizHint").innerHTML="",e("#quizTitle").innerHTML="",e("#quizString").innerHTML="",f.data[l]?.quizesCasesId?se(l):D(l)},!1)})}}function re(a){a.preventDefault();let t=e("#inputFormula").value,i=n.getState().application.activePage,{dataArray:s=[],type:l}=f.data[i];l.includes("case")?t.includes(":")?x(s,t,"#resformula"):G(t,"#resformula"):x(t,"#resformula")}function le(a){a.preventDefault();let t={email:document.getElementById("emailInput")?.value,user:document.getElementById("userInput")?.value};_({application:t}),window.location.reload()}e("#loginbutton").addEventListener("click",a=>le(a),!1),e("#quizform").addEventListener("submit",ae);const oe=new Z("quizChecks",ie),ue=new K("quizChecks",ne);e("#inputFormula").addEventListener("input",a=>re(a),!1);async function ce(){let a=await U();console.log(a),a?(k=await n.dispatch(w.endpoints.fetchUserPosts.initiate(a.userEmail)),console.log(k),f=await n.dispatch(w.endpoints.fetchQuizesArray.initiate()),n.dispatch(ee([...new Set(k.data.map(t=>L(t.title,t?.quizString)))])),n.dispatch(J(a)),n.dispatch(B(0))):e("#formcontainer").style.display="block"}ce().then(()=>{console.log("quizcardwithstorage"),e("#quizcontainer").style.display="block",I()})}));
