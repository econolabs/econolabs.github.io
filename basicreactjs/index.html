<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="../dist/original.css" />

    <title>Basic react js</title>
  </head>

  <body
    data-api="AIzaSyDUamZR2aXuP2rFG1AFpb1Ni8aZA5uhSj4"
    data-base="fincalculations"
    data-app="1:892270777573:web:bdc13e9b47334b4319700c"
  >
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a target="_blank" class="navbar-brand" href="/">Econolabs</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="#"><span class="sr-only"></span></a>
          </li>
        </ul>
        <form class="form-inline my-2 my-lg-0">
          <a href="https://vk.com/dmglvn">
            <img
              loading="lazy"
              src="https://sun9-37.userapi.com/c317630/v317630439/76a0/Bz6QTfBog0I.jpg?ava=1"
              alt=""
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                filter: grayscale(100%);
                object-fit: cover;
              "
            />
          </a>
        </form>
      </div>
    </nav>

    <div class="container" id="root"></div>

    <script src="../dist/babel.standalone7.27.6.min.js"></script>

    <script src="../dist/basicfirebasecrudservices.js"></script>
    <script src="../dist/react18.3.1.production.min.js"></script>
    <script src="../dist/react-dom18.3.1.production.min.js"></script>
    <script src="../dist/react-bootstrap1.6.8.min.js"></script>
    <script src="../dist/redux-toolkit.umd.min.js"></script>

    <script type="text/babel">
      let { createRoot } = ReactDOM;
      let { useReducer } = React;
      let { Form, Row, Col, Container } = ReactBootstrap;
      let { caseReducer, getFirebaseNode } = basicfirebasecrudservices;
      let { createSlice, createApi, configureStore, setupListeners, fakeBaseQuery} = RTK;


      /**
* Store
*/

const initialState = {

    email: '',
    userEmail: "",
    user: '',
    avatarUrl: '',

    activePostId: null,
    previousPostId: null,

    activePage: null,
    previousPage: null,

    startIndex: 0,
    endIndex: 10,

    pageLength: 10

}



const applicationSlice = createSlice({
    name: 'application',
    initialState,
    reducers: {

        setPageLength: (state, action) => {
            state.pageLength = action.payload;
            state.endIndex = action.payload;
        },


        setActivePage: (state, action) => {
            state.previousPage = state.activePage;
            state.activePage = action.payload;
            state.startIndex = (action.payload - 1) * state.pageLength;
            state.endIndex = action.payload * state.pageLength;
            state.previousPostId = null
            state.activePostId = null;
        },


        setUser: (state, action) => {
            state.email = action.payload.email,
                state.userEmail = action.payload.userEmail,
                state.user = action.payload.user,
                state.avatarUrl = action.payload?.avatarUrl ? action.payload?.avatarUrl : 'https://images.unsplash.com/photo-1536300099515-6c61b290b654?q=80&w=200&auto=format&fit=crop',
                state.isLoading = false
        },

        setAvatar: (state, action) => {
            state.avatarUrl = action.payload
        },

        setSelectedPostId: (state, action) => {
            state.previousPostId = state.activePostId;
            state.activePostId = action.payload;
        },

        closePost: (state) => {
            state.previousPostId = null
            state.activePostId = null;
        },

    }
})

// Action creators are generated for each case reducer function
const { setSelectedPostId, closePost, setUser, setAvatar, setActivePage, setPageLength

} = applicationSlice.actions





// const api = createApi({
//     reducerPath: 'api',
//     tagTypes: ["Post", "Avatar"],
//     baseQuery: fakeBaseQuery(),
//     endpoints: (builder) => ({

//         fetchUserPosts: builder.query({
//             async queryFn(userEmail) {
//                 try {
//                     let list = await getFirebaseNode({ url: "usersCraft/" + userEmail + "/posts", type: "array" });
//                     return { data: list }
//                 }
//                 catch (err) { console.log(err); return { error: err } }
//             },
//             providesTags: (result, error, id) => [{ type: "Post", id }]
//         }),

//         fetchUserAvatar: builder.query({
//             async queryFn(userEmail) {
//                 try {
//                     let openAvatarsResponse = await getFirebaseNode({
//                         url: "/openavatars/" + userEmail,
//                         type: "object"
//                     });

//                     return { data: openAvatarsResponse }
//                 }
//                 catch (err) { console.log(err); return { data: null, error: err } }
//             },
//             providesTags: (result, error, id) => [{ type: "Avatar", id }]
//         }),

//         updatesForUserPosts: builder.mutation({
//             async queryFn({ base = "", updates = { temp: "temp" }
//             }) {
//                 let fireUpdates = {};
//                 Object.keys(updates).forEach(objKey => {
//                     fireUpdates[base + "/" + objKey] = updates[objKey]
//                 });
//            //     console.log(fireUpdates);
//                 try { await updateFirebaseNode(fireUpdates) }
//                 catch (err) { console.log(err); return { error: err } }
//                 return { data: fireUpdates }
//             },
//             invalidatesTags: ["Post"]
//         }),
//     }),
// })

const store = configureStore({
    reducer: {
        application: applicationSlice.reducer,
        // [api.reducerPath]: api.reducer
    },
    // middleware: (getDefaultMiddleware) =>
    //     getDefaultMiddleware().concat(api.middleware),
})
// setupListeners(store.dispatch);

      function SelectDate({ setDate }) {
        async function handleChange(e) {
          let { name, value } = e.target;

          console.log(name, value);
          let d = new Date(e.target.value);

          let currentDay = new Intl.DateTimeFormat("en", {
            weekday: "short",
            year: "numeric",
            month: "short",
            day: "numeric",
          })
            .format(new Date(d.getFullYear(), d.getMonth(), d.getDate()))
            .replace(/[^a-zA-Z0-9]/g, "_");
          setDate(currentDay);
        }

        return (
          <Container>
            <Form>
              <Row>
                <Col>
                  <Form.Group controlId="formStatePeriod">
                    <Form.Label>Период</Form.Label>
                    <Form.Control
                      type="date"
                      name="selecteddate"
                      required
                      onChange={handleChange}
                    />
                  </Form.Group>
                </Col>
              </Row>
            </Form>
          </Container>
        );
      }

      function App() {
        const [state, dispatch] = useReducer(caseReducer, {
          isLoading: true,
        });

        async function setDate(currentDay) {
          console.log(currentDay);
          let res = await getFirebaseNode({
            url: "/currentDay/" + currentDay + "/posts",
            type: "array",
          });
          let uniqueUserEmails = [
            ...new Set(
              res.map((item) => item?.email.replace(/[^a-zA-Z0-9]/g, "_"))
            ),
          ];
          console.log(uniqueUserEmails);

          let updatedopenavatars = {};

          await Promise.all(
            uniqueUserEmails.map((userEmail) => {
              return getFirebaseNode({
                url: "openavatars/" + userEmail,
                type: "object",
              });
            })
          ).then((values) => {
            values.forEach(
              (result, index) =>
                (updatedopenavatars[uniqueUserEmails[index]] = result)
            );
            console.log(updatedopenavatars);
          });
          dispatch({
            type: "SEED_STATE",
            payload: {
              object: {
                isLoading: false,
                updatedopenavatars,
                uniqueUserEmails,
              },
            },
          });
        }

        console.log(state);
        return (
          <Container>
            <SelectDate setDate={setDate} />
          </Container>
        );
      }

      createRoot(root).render(<App />);
    </script>
  </body>
</html>
